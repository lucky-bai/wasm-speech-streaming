<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Candle Moshi ASR ‚Äî Simplified</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;600;700&display=swap");
      html, body { font-family: "Source Sans 3", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    </style>
    <script src="css/tailwind-3.4.17.js"></script>
    <script type="module">
      const MODEL_ID = "moshi_1b_en_fr_q4k";
      const WEIGHTS_URL = "https://huggingface.co/efficient-nlp/stt-1b-en_fr-quantized/resolve/main/model-q4k.gguf";
      const MIMI_URL = "https://huggingface.co/efficient-nlp/stt-1b-en_fr-quantized/resolve/main/mimi-pytorch-e351c8d8@125.safetensors";
      const TOKENIZER_URL = "https://huggingface.co/efficient-nlp/stt-1b-en_fr-quantized/resolve/main/tokenizer_en_fr_audio_8000.json";
      const CONFIG_URL = "https://huggingface.co/efficient-nlp/stt-1b-en_fr-quantized/resolve/main/config.json";

      const AUDIO_BASE_URL = "/audios/";
      const SAMPLES = [
        { file: "samples_jfk.wav", label: "jfk.wav", size: "352 kB" },
        { file: "samples_chessvideo.wav", label: "chessvideo.wav", size: "3.7 MB" },
      ];

      const moshiWorker = new Worker("./moshiWorker.js", { type: "module" });
      let audioURL = null;

      function setAudio(src) {
        const audio = document.querySelector("#audio");
        audio.src = src;
        audio.hidden = false;
        audio.controls = true;
        document.querySelector("#detect").disabled = false;
        document.querySelector("#output-generation").textContent = "";
        document.querySelector("#output-status").hidden = false;
        document.querySelector("#output-status").textContent = "Ready to transcribe";
        audioURL = src;
      }

      function updateStatus(data) {
        const { status, message } = data;
        const button = document.querySelector("#detect");
        if (status === "loading" || status === "decoding") {
          button.disabled = true;
          button.textContent = message || (status === "loading" ? "Loading..." : "Decoding...");
        } else if (status === "complete") {
          button.disabled = false;
          button.textContent = "Transcribe Audio";
        }
      }

      async function transcribeAudio() {
        return new Promise((resolve, reject) => {
          moshiWorker.postMessage({
            weightsURL: WEIGHTS_URL,
            modelID: MODEL_ID,
            mimiURL: MIMI_URL,
            tokenizerURL: TOKENIZER_URL,
            configURL: CONFIG_URL,
            audioURL,
          });

          function handler(event) {
            const data = event.data;
            if ("status" in data) updateStatus(data);
            if ("error" in data) {
              moshiWorker.removeEventListener("message", handler);
              reject(new Error(data.error));
            }
            if (data.status === "complete") {
              moshiWorker.removeEventListener("message", handler);
              resolve(data);
            }
          }
          moshiWorker.addEventListener("message", handler);
        });
      }

      const samplesEl = document.querySelector("#audios-select");
      for (const s of SAMPLES) {
        const btn = document.createElement("button");
        btn.className = "text-gray-600 border border-gray-400 rounded-md px-3 py-2 hover:border-gray-600";
        btn.textContent = `${s.label}`;
        const size = document.createElement("span");
        size.textContent = ` (${s.size})`;
        size.className = "text-xs ml-1";
        btn.appendChild(size);
        btn.addEventListener("click", () => setAudio(AUDIO_BASE_URL + s.file));
        samplesEl.appendChild(btn);
      }

      document.querySelector("#detect").addEventListener("click", async () => {
        if (!audioURL) return;
        try {
          const result = await transcribeAudio();
          const text = (result.output || [])
            .map(seg => (seg?.dr?.text ?? "").trim())
            .filter(Boolean)
            .join(" ");
          document.querySelector("#output-status").hidden = true;
          document.querySelector("#output-generation").hidden = false;
          document.querySelector("#output-generation").textContent = text || "(No text returned)";
        } catch (err) {
          console.error(err);
          document.querySelector("#output-status").hidden = false;
          document.querySelector("#output-status").textContent = "Error: " + err.message;
        }
      });
    </script>
  </head>
  <body class="container max-w-4xl mx-auto p-4">
    <main class="grid grid-cols-1 gap-8 relative">
      <span class="absolute text-5xl -ml-[1em]">üïØÔ∏è</span>
      <div>
        <h1 class="text-5xl font-bold">Candle Moshi ASR</h1>
        <h2 class="text-2xl font-semibold">Rust/WASM Demo</h2>
        <p class="max-w-lg text-gray-700">
          Transcribe audio in the browser using Rust/WASM with an audio file.
          This demo uses the
          <a href="https://huggingface.co/openai/" target="_blank" class="underline hover:text-blue-600">Moshi ASR models</a>
          and a WASM runtime built with
          <a href="https://github.com/huggingface/candle/" target="_blank" class="underline hover:text-blue-600">Candle</a>.
        </p>
      </div>

      <div>
        <div class="flex flex-wrap gap-3 items-center" id="audios-select">
          <h3 class="font-medium mr-2">Examples:</h3>
        </div>
      </div>

      <audio id="audio" hidden controls class="w-full p-2 select-none"></audio>

      <div>
        <button id="detect" disabled class="bg-gray-700 hover:bg-gray-800 text-white font-normal py-2 px-4 rounded disabled:bg-gray-300 disabled:cursor-not-allowed">
          Transcribe Audio
        </button>
      </div>

      <div>
        <h3 class="font-medium">Transcription:</h3>
        <div class="min-h-[200px] bg-slate-100 text-gray-700 p-4 rounded-md">
          <p id="output-generation" hidden></p>
          <span id="output-status" class="font-light">No transcription results yet</span>
        </div>
      </div>
    </main>
  </body>
</html>